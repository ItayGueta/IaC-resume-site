name: Build and Deploy Resume Site

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "Deploy destination override"
        required: true
        default: "auto"
        type: choice
        options:
          - auto
          - beta
          - production
  push:
    paths:
      - "site/config.toml"
      - "site/content/**"
      - "site/layouts/**"
      - "site/static/**"
      - "ansible/**"
      - "terraform/**"
      - ".github/workflows/main.yml"
  pull_request:
    paths:
      - "site/config.toml"
      - "site/content/**"
      - "site/layouts/**"
      - "site/static/**"
      - "ansible/**"
      - "terraform/**"
      - ".github/workflows/main.yml"

concurrency:
  group: resume-site-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate_site:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.148.2"
          extended: true

      - name: Build site
        run: hugo --minify -s site

  deploy_site:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: validate_site
    runs-on: ubuntu-latest
    environment: ${{ (github.event_name == 'workflow_dispatch' && inputs.deploy_target == 'production') && 'production' || (github.event_name == 'workflow_dispatch' && inputs.deploy_target == 'beta') && 'beta' || github.ref_name == 'master' && 'production' || 'beta' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.148.2"
          extended: true

      - name: Set deploy target
        run: |
          target="auto"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            target="${{ inputs.deploy_target }}"
          fi

          if [ "$target" = "production" ] || { [ "$target" = "auto" ] && [ "${GITHUB_REF_NAME}" = "master" ]; }; then
            echo "DEPLOY_PATH=/var/www/resume-site/" >> "$GITHUB_ENV"
            echo "HUGO_BASE_URL=https://itaygueta.com/" >> "$GITHUB_ENV"
          else
            echo "DEPLOY_PATH=/var/www/resume-site-beta/" >> "$GITHUB_ENV"
            echo "HUGO_BASE_URL=https://beta.itaygueta.com/" >> "$GITHUB_ENV"
          fi

      - name: Build site
        run: hugo --minify -s site --baseURL "$HUGO_BASE_URL"

      - name: Rsync to server
        uses: burnett01/rsync-deployments@7.0.2
        with:
          switches: -avz --delete --rsync-path="sudo rsync"
          path: site/public/
          remote_host: ${{ secrets.DEPLOY_HOST }}
          remote_user: deploy
          remote_key: ${{ secrets.DEPLOY_SSH_KEY }}
          remote_path: ${{ env.DEPLOY_PATH }}

      - name: Smoke check deployed site
        run: curl --retry 5 --retry-delay 2 --retry-connrefused -fI "$HUGO_BASE_URL"
